// ========================================================
// 3D Printing E-Commerce Database Schema
// ========================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================================
// ENUM DEFINITIONS
// ========================================================

enum UserRole {
  CUSTOMER
  ADMIN
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PRINTING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  UNPAID
  PAID
  REFUNDED
  FAILED
}

enum PaymentMethod {
  CREDIT_CARD
  PAYPAL
  BANK_TRANSFER
  CASH_ON_DELIVERY
}

enum ShipmentStatus {
  PREPARING
  IN_TRANSIT
  DELIVERED
  RETURNED
}

// ========================================================
// USER & AUTH DOMAIN
// ========================================================

model User {
  id           String   @id @default(uuid())
  username     String   @unique @db.VarChar(50)
  email        String   @unique @db.VarChar(255)
  passwordHash String   @map("password_hash") @db.VarChar(255)
  role         UserRole @default(CUSTOMER)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  profile       Profile?
  refreshTokens RefreshToken[]
  addresses     Address[]
  orders        Order[]
  cart          Cart?
  reviews       Review[]
  qnas          QnA[]
}

model Profile {
  id          String   @id @default(uuid())
  userId      String   @unique @map("user_id")
  fullName    String?  @db.VarChar(100)
  phoneNumber String?  @map("phone_number") @db.VarChar(20)
  avatarUrl   String?  @map("avatar_url")
  bio         String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Address {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  recipient String   @db.VarChar(100)
  phone     String   @db.VarChar(20)
  address1  String   @db.VarChar(255)
  address2  String?  @db.VarChar(255)
  city      String   @db.VarChar(100)
  state     String   @db.VarChar(100)
  postal    String   @db.VarChar(20)
  country   String   @db.VarChar(50)
  isDefault Boolean  @default(false) @map("is_default")
  createdAt DateTime @default(now()) @map("created_at")

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders Order[]
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique @db.VarChar(500)
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("refresh_tokens")
}

// ========================================================
// PRODUCT & CATALOG DOMAIN
// ========================================================

model Product {
  id          String   @id @default(uuid())
  name        String   @db.VarChar(255)
  description String?  @db.Text
  basePrice   Decimal  @map("base_price") @db.Decimal(12, 2)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  variants  Variant[]
  images    MediaAsset[]
  reviews   Review[]
  qnas      QnA[]
  tags      ProductTag[]
  // inventory Inventory?

  @@map("products")
}

model Variant {
  id         String   @id @default(uuid())
  productId  String   @map("product_id")
  materialId String   @map("material_id")
  name       String   @db.VarChar(100)
  stock      Int      @default(0)
  createdAt  DateTime @default(now()) @map("created_at")

  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  material  Material  @relation(fields: [materialId], references: [id], onDelete: Cascade)
  orders    OrderItem[]
  CartItem  CartItem[]

  @@map("variants")
}

model Material {
  id          String   @id @default(uuid())
  name        String   @db.VarChar(100)
  color       String?  @db.VarChar(50)
  density     Float?   @db.DoublePrecision
  priceFactor Float?   @default(1.0) @db.DoublePrecision
  createdAt   DateTime @default(now()) @map("created_at")

  variants  Variant[]

  @@map("materials")
}

// model Inventory {
//   id        String   @id @default(uuid())
//   productId String   @unique @map("product_id")
//   quantity  Int      @default(0)
//   updatedAt DateTime @updatedAt @map("updated_at")

//   product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

//   @@map("inventories")
// }

model MediaAsset {
  id        String   @id @default(uuid())
  productId String?  @map("product_id")
  url       String   @db.VarChar(500)
  type      String   @db.VarChar(50)
  altText   String?  @map("alt_text")
  createdAt DateTime @default(now()) @map("created_at")

  product Product? @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("media_assets")
}

model Tag {
  id   String @id @default(uuid())
  name String @unique @db.VarChar(50)

  products ProductTag[]

  @@map("tags")
}

model ProductTag {
  productId String @map("product_id")
  tagId     String @map("tag_id")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([productId, tagId])
  @@map("product_tags")
}

// ========================================================
// ORDER, CART & PAYMENT DOMAIN
// ========================================================

model Cart {
  id        String   @id @default(uuid())
  userId    String   @unique @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items CartItem[]

  @@map("carts")
}

model CartItem {
  id        String   @id @default(uuid())
  cartId    String   @map("cart_id")
  variantId String   @map("variant_id")
  quantity  Int      @default(1)
  createdAt DateTime @default(now()) @map("created_at")

  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  variant Variant @relation(fields: [variantId], references: [id], onDelete: Restrict)

  @@unique([cartId, variantId])
  @@map("cart_items")
}

model Order {
  id          String      @id @default(uuid())
  userId      String      @map("user_id")
  addressId   String      @map("address_id")
  status      OrderStatus @default(PENDING)
  totalAmount Decimal     @map("total_amount") @db.Decimal(12, 2)
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  user     User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  address  Address     @relation(fields: [addressId], references: [id], onDelete: Restrict)
  items    OrderItem[]
  payment  Payment?
  shipment Shipment?

  @@map("orders")
}

model OrderItem {
  id        String   @id @default(uuid())
  orderId   String   @map("order_id")
  variantId String   @map("variant_id")
  quantity  Int      @default(1)
  price     Decimal  @db.Decimal(12, 2)
  createdAt DateTime @default(now()) @map("created_at")

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  variant Variant @relation(fields: [variantId], references: [id], onDelete: Restrict)

  @@map("order_items")
}

model Payment {
  id            String        @id @default(uuid())
  orderId       String        @unique @map("order_id")
  method        PaymentMethod @default(CREDIT_CARD)
  status        PaymentStatus @default(UNPAID)
  amount        Decimal       @db.Decimal(12, 2)
  transactionId String?       @map("transaction_id")
  createdAt     DateTime      @default(now()) @map("created_at")

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model Shipment {
  id          String         @id @default(uuid())
  orderId     String         @unique @map("order_id")
  carrier     String?        @db.VarChar(100)
  trackingNo  String?        @map("tracking_no")
  status      ShipmentStatus @default(PREPARING)
  shippedAt   DateTime?      @map("shipped_at")
  deliveredAt DateTime?      @map("delivered_at")

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("shipments")
}

// ========================================================
// CONTENT & MARKETING DOMAIN
// ========================================================

model Review {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  productId String   @map("product_id")
  rating    Int      @default(5)
  comment   String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@map("reviews")
}

model QnA {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  productId String   @map("product_id")
  question  String   @db.Text
  answer    String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("qna")
}

model Voucher {
  id        String   @id @default(uuid())
  code      String   @unique @db.VarChar(50)
  discount  Float    @db.DoublePrecision
  expiresAt DateTime @map("expires_at")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("vouchers")
}
